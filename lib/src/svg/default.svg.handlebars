{{! Load common helpers }}
{{>_helpers~}}

{{! Root template }}
{{~#*inline "root"}}
<!-- Created with {{{creator.name}}} v{{{creator.version}}} ({{{creator.repo}}}) -->
<svg viewBox="0 {{#if window_frame}}-{{const.WINDOW_FRAME_HEIGHT}}{{else}}0{{/if}} {{width}} {{height}}" width="{{width}}" height="{{height}}" xmlns="http://www.w3.org/2000/svg">
  <switch>
    <g requiredExtensions="http://www.w3.org/1999/xhtml">
      {{>styles}}
      {{>background}}

      {{~>content}}
    </g>
    {{>unsupported_error}}
  </switch>
</svg>
{{/inline~}}

{{! NB. The warning text should fit in one 80-char line to not potentially overflow the viewbox. }}
{{~#*inline "unsupported_error"}}
<text x="10" y="{{line_height}}" style="font: {{const.FONT_SIZE}}px monospace; fill: {{ palette.colors.red }};">
  HTML embedding not supported.
  Consult <tspan style="text-decoration: underline; text-decoration-thickness: 1px;"><a href="https://github.com/slowli/term-transcript/blob/HEAD/FAQ.md">term-transcript docs</a></tspan> for details.
</text>
{{/inline~}}

{{!
  Computes scroll animation parameters.
  Expected hash inputs: `content_height`, `const`, `scroll`

  We use different ways to animate scrolling in this template and the pure SVG template because
  animation via <animate> for HTML content inside SVG leads to visual artifacts in Safari / WebKit.
}}
{{~#*inline "compute_scroll_animation"}}
  {{#if (gte scroll.max_height content_height)}}
  {{! No need for scroll animation }}
    null
  {{else}}
    {{#scope
      scroll_height=(sub content_height scroll.max_height)
      steps=(add (div (sub content_height scroll.max_height) scroll.pixels_per_scroll round="up") 1)
    }}
      {
        "scroll": [
          {{#each (range 0 (steps)) as |step_idx|}}
            {{#scope pos=(min (scroll_height) (mul ../scroll.pixels_per_scroll step_idx))}}
            {
              "key": {{round (mul 100 (div step_idx (steps))) digits=2}},
              "top": {{sub 0 (pos)}},
              {{! Map from the viewport scroll range to the scrollbar range }}
              "bar_top": {{round
                (mul (div (pos) (scroll_height)) (sub ../scroll.max_height ../const.SCROLLBAR_HEIGHT))
                digits=1
              }}
            }
            {{/scope}}
            {{#if (not @last)}},{{/if}}
          {{/each}}
        ],
        "duration": {{mul scroll.interval (steps)}}
      }
    {{/scope}}
  {{/if}}
{{/inline~}}

{{! CSS definitions }}
{{~#*inline "styles"}}
<style>
  {{>common_styles_header}}
  .viewport {
    position: absolute;
    width: 100%;
    height: {{screen_height}}px;
    top: {{const.WINDOW_PADDING}}px;
    overflow: hidden;
  }
  {{#with (scroll_animation) as |anim|}}
  @keyframes scroll {
    {{#each anim.scroll as |keyframe|}}
    {{keyframe.key}}% { top: {{keyframe.top}}px; }
    {{/each}}
  }
  @keyframes scrollbar {
    {{#each anim.scroll as |keyframe|}}
    {{keyframe.key}}% { top: {{keyframe.bar_top}}px; }
    {{/each}}
  }
  .scrollbar {
    background: rgba(255, 255, 255, 0.35);
    position: absolute;
    width: 5px; height: {{../const.SCROLLBAR_HEIGHT}}px;
    right: {{../const.SCROLLBAR_RIGHT_OFFSET}}px; top: 0;
    animation: {{anim.duration}}s steps(1, jump-end) 0s infinite scrollbar;
  }
  {{~else}}{{/with}}
  .container {
    padding: 0 {{const.WINDOW_PADDING}}px;
    color: {{ palette.colors.white }};
    line-height: {{line_height}}px;
    position: relative;
    {{#with (scroll_animation) as |anim|}}
    animation: {{anim.duration}}s steps(1, jump-end) 0s infinite scroll;
    {{~else}}{{/with}}
  }
  .container pre {
    padding: 0;
    margin: 0;
    font: {{const.FONT_SIZE}}px {{#if embedded_font}}"{{embedded_font.family_name}}", monospace{{else}}{{font_family}}{{/if}};
    line-height: inherit;
  }
  .input {
    {{~#if (eq line_numbers "continuous")}}

    display: flex;
    {{~/if}}

    margin: 0 -{{const.WINDOW_PADDING}}px {{const.BLOCK_MARGIN}}px;
    color: {{ palette.colors.white }};
    background: rgba(255, 255, 255, 0.1);
    padding: 2px {{const.WINDOW_PADDING}}px;
  }
  .input-hidden { display: none; }
  {{~#if (eq line_numbers "continuous")}}

  .input > pre { flex-grow: 1; }
  {{~/if}}

  .output { {{#if line_numbers}}display: flex; {{/if}}margin-bottom: {{const.BLOCK_MARGIN}}px; }
  {{~#if line_numbers}}

  .output > pre { flex-grow: 1; }
  pre.line-numbers {
    flex-grow: 0;
    width: {{const.LN_WIDTH}}px;
    text-align: right;
    padding-right: {{const.LN_PADDING}}px;
    opacity: 0.35;
    user-select: none;
  }
  {{/if}}
  {{~#if has_failures}}

  .input-failure {
    border-left: 2px solid {{ palette.colors.red }};
    border-right: 2px solid {{ palette.colors.red }};
    background: rgba(255, 0, 65, 0.15);
  }
  {{/if}}

  {{>common_font_styles}}
  .dimmed { opacity: 0.7; }
  {{~#if wrap}}

  .hard-br {
    position: relative;
    margin-left: 8px;
  }
  .hard-br:before {
    content: 'Â»';
    opacity: 0.6;
  }
  {{~/if}}

  .line { display: block; }
  .line > span { display: inline-block; }
  .fg0 { color: {{ palette.colors.black }}; } .bg0 { background: {{ palette.colors.black }}; }
  .fg1 { color: {{ palette.colors.red }}; } .bg1 { background: {{ palette.colors.red }}; }
  .fg2 { color: {{ palette.colors.green }}; } .bg2 { background: {{ palette.colors.green }}; }
  .fg3 { color: {{ palette.colors.yellow }}; } .bg3 { background: {{ palette.colors.yellow }}; }
  .fg4 { color: {{ palette.colors.blue }}; } .bg4 { background: {{ palette.colors.blue }}; }
  .fg5 { color: {{ palette.colors.magenta }}; } .bg5 { background: {{ palette.colors.magenta }}; }
  .fg6 { color: {{ palette.colors.cyan }}; } .bg6 { background: {{ palette.colors.cyan }}; }
  .fg7 { color: {{ palette.colors.white }}; } .bg7 { background: {{ palette.colors.white }}; }
  .fg8 { color: {{ palette.intense_colors.black }}; } .bg8 { background: {{ palette.intense_colors.black }}; }
  .fg9 { color: {{ palette.intense_colors.red }}; } .bg9 { background: {{ palette.intense_colors.red }}; }
  .fg10 { color: {{ palette.intense_colors.green }}; } .bg10 { background: {{ palette.intense_colors.green }}; }
  .fg11 { color: {{ palette.intense_colors.yellow }}; } .bg11 { background: {{ palette.intense_colors.yellow }}; }
  .fg12 { color: {{ palette.intense_colors.blue }}; } .bg12 { background: {{ palette.intense_colors.blue }}; }
  .fg13 { color: {{ palette.intense_colors.magenta }}; } .bg13 { background: {{ palette.intense_colors.magenta }}; }
  .fg14 { color: {{ palette.intense_colors.cyan }}; } .bg14 { background: {{ palette.intense_colors.cyan }}; }
  .fg15 { color: {{ palette.intense_colors.white }}; } .bg15 { background: {{ palette.intense_colors.white }}; }
</style>
{{/inline~}}

{{~#*inline "content"}}
      <svg width="{{width}}" height="{{add (screen_height) const.WINDOW_PADDING}}" viewBox="0 0 {{width}} {{add (screen_height) const.WINDOW_PADDING}}">
        <foreignObject width="{{width}}" height="{{add (screen_height) const.WINDOW_PADDING}}">
          <div xmlns="http://www.w3.org/1999/xhtml" class="viewport"><div class="container">
            {{~#each interactions}}

            <div class="input{{#if failure}} input-failure{{/if}}{{#if input.hidden}} input-hidden{{/if}}"
              {{~#if (ne exit_status null)}} data-exit-status="{{exit_status}}"{{/if~}}
              {{~#if failure}} title="This command exited with non-zero code"{{/if}}>
              {{~#if (and (eq ../line_numbers "continuous") (not input.hidden))}}{{>number_input_lines}}{{/if~}}
              <pre><span class="prompt">{{ input.prompt }}</span> {{ input.text }}</pre></div>
            <div class="output">
              {{~#if ../line_numbers~}}
                {{~>number_output_lines~}}
                {{~#if (ne ../line_numbers "each_output")~}}
                  {{~line_number set=(add (line_number) (len output))~}}
                {{~/if~}}
              {{~/if~}}
              <pre>
              {{~#each output as |line|~}}
                <span class="line">
                {{~#each line.spans as |span|~}}
                    {{{eval ">html_span" span=span}}}
                {{~else~}}{{! The line may be empty }}
                {{~/each~}}
                {{~#if line.br}}<b class="hard-br"></b>{{/if~}}
                {{! Add a newline in order to make the text correctly copyable }}
                {{~#if (not @last)}}

                {{/if~}}
                </span>
              {{~else~}}{{! The output may be empty }}
              {{~/each~}}
              </pre></div>
            {{~/each}}

          </div>{{#if (scroll_animation)}}<div class="scrollbar"></div>{{/if}}</div>
        </foreignObject>
      </svg>
{{/inline~}}

{{~#*inline "number_input_lines"~}}
  <pre class="line-numbers">
    {{~#each (range 0 (count_lines input.text))~}}
      {{add this (line_number)}}{{#if @last}}{{else}}<br/>{{/if}}
    {{~/each~}}
  </pre>
  {{~line_number set=(add (line_number) (count_lines input.text))~}}
{{~/inline~}}

{{~#*inline "number_output_lines"}}
<pre class="line-numbers">
  {{~#each (range 0 (len output))~}}
    {{add this (line_number)}}{{#if @last}}{{else}}<br/>{{/if}}
  {{~/each~}}
</pre>
{{~/inline~}}

{{! Main logic }}
{{#scope
  content_height=0
  scroll_animation=null
  screen_height=0
  height=0
  width=width
  line_height=line_height
  letter_spacing_ems=0
  line_number=1
}}
  {{~>set_line_height ~}}
  {{~content_height set=(round
    (eval "compute_content_height" const=const line_height=(line_height) interactions=interactions)
    digits=1
  )~}}
  {{~#if scroll~}}
    {{scroll_animation set=(eval "compute_scroll_animation"
      const=const
      scroll=scroll
      content_height=(content_height)
    )}}
  {{~/if~}}
  {{~#if (scroll_animation)~}}
    {{screen_height set=scroll.max_height}}
  {{~else~}}
    {{screen_height set=(content_height)}}
  {{~/if~}}
  {{~height set=(add (screen_height) (mul const.WINDOW_PADDING 2))~}}
  {{~#if window_frame~}}
    {{height set=(add (height) const.WINDOW_FRAME_HEIGHT)}}
  {{~/if~}}
  {{~#if line_numbers~}}
    {{! Adjust width to take line numbers into account }}
    {{~width set=(add (width) const.LN_WIDTH const.LN_PADDING)~}}
  {{~/if~}}
{{>root~}} {{! <-- All rendering happens here }}
{{/scope}}
